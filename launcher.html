<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Admin</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://app.speeddelivro.com/admin_icon.png">
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; width: 100vw; overflow: hidden; background: #333; }
        
        #contentFrame {
            position: absolute; top: 0; left: 0; width: 100%;
            height: calc(100% - 60px); border: none; background: #f5f5f5;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 9999;
        }
        .nav-item { text-decoration: none; color: #999; text-align: center; font-size: 11px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; cursor: pointer; }
        .nav-item.active { color: #2563eb; font-weight: bold; background-color: #f0f7ff; }
        .nav-icon { font-size: 22px; margin-bottom: 2px; display: block; }

        #bgModeBtn {
            position: fixed; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.6); color: white; 
            padding: 5px 10px; border-radius: 15px; font-size: 10px; 
            z-index: 10000; cursor: pointer; border: 1px solid white;
        }

        /* Style Alerte Rouge pour √™tre bien visible */
        #customToast {
            position: fixed; top: -150px; left: 5%; width: 90%; 
            background: white; border-left: 8px solid #e74c3c; 
            box-shadow: 0 10px 100px rgba(0,0,0,0.5); 
            border-radius: 8px; padding: 20px; z-index: 10001; 
            transition: top 0.5s ease; display: flex; align-items: center; gap: 15px;
            cursor: pointer;
        }
        .toast-content h4 { margin: 0; color: #e74c3c; font-size: 18px; text-transform: uppercase; }
        .toast-content p { margin: 5px 0 0 0; color: #333; font-size: 15px; font-weight: bold; }
        .stop-btn { margin-top: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <script>
        if (localStorage.getItem('admin_auth') !== 'true') window.location.replace('auth.html');
    </script>

    <iframe id="contentFrame" src="admin-order.html"></iframe>

    <div id="bgModeBtn" onclick="toggleBackgroundMode()">üí§ Mode Veille D√©sactiv√©</div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="loadPage('admin-order.html', this)"><span class="nav-icon">‚ûï</span>Cr√©er</div>
        <div class="nav-item" onclick="loadPage('https://www.speeddelivro.com/admin/orders/listing', this)"><span class="nav-icon">üìã</span>G√©rer</div>
        <div class="nav-item" onclick="loadPage('https://www.speeddelivro.com/admin/reports/drivers-map', this)"><span class="nav-icon">üó∫Ô∏è</span>Carte</div>
    </div>

    <!-- AUDIO EN BOUCLE -->
    <audio id="keepAliveSound" loop><source src="https://github.com/anars/blank-audio/raw/master/1-hour-of-silence.mp3" type="audio/mpeg"></audio>
    <!-- On ajoute 'loop' pour que √ßa sonne jusqu'√† l'infini -->
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop preload="auto"></audio>

    <!-- TOAST ALARME (Cliquable pour arr√™ter) -->
    <div id="customToast" onclick="stopAlarm()">
        <div style="font-size: 40px;">üö®</div>
        <div class="toast-content">
            <h4>Nouvelle Commande !</h4>
            <p id="toastMsg">...</p>
            <button class="stop-btn">CLIQUEZ POUR ARR√äTER</button>
        </div>
    </div>

    <script>
        // --- 1. NAVIGATION ---
        function loadPage(url, el) {
            document.getElementById('contentFrame').src = url;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        // --- 2. BACKGROUND MODE ---
        let isBackgroundMode = false;
        function toggleBackgroundMode() {
            const audio = document.getElementById('keepAliveSound');
            const btn = document.getElementById('bgModeBtn');
            if (!isBackgroundMode) {
                audio.play().then(() => {
                    btn.style.background = "#2ecc71"; btn.innerHTML = "‚ö° Mode Arri√®re-plan ACTIF"; isBackgroundMode = true;
                }).catch(e => alert("Cliquez sur la page !"));
            } else {
                audio.pause(); btn.style.background = "rgba(0,0,0,0.6)"; btn.innerHTML = "üí§ Mode Veille D√©sactiv√©"; isBackgroundMode = false;
            }
        }

        // --- 3. ALARME & RADAR ---
        if (Notification.permission !== "granted") Notification.requestPermission();
        
        let lastKnownOrderId = localStorage.getItem('last_known_order') || '';
        const CUSTOM_ICON = "https://app.speeddelivro.com/admin_icon.png";
        let isAlarmPlaying = false;

        function triggerAlarm(msg, type, amount) {
            if (isAlarmPlaying) return; // D√©j√† en train de sonner

            // 1. Visuel
            const toast = document.getElementById('customToast');
            document.getElementById('toastMsg').innerHTML = msg;
            toast.style.top = "20px"; // Descend la banni√®re

            // 2. Audio (Boucle)
            const sound = document.getElementById('notifSound');
            sound.volume = 1.0;
            sound.play().catch(e => console.log("Erreur lecture son"));
            isAlarmPlaying = true;

            // 3. Vibration longue (Boucle simul√©e)
            if ("vibrate" in navigator) navigator.vibrate([1000, 500, 1000, 500, 1000]);

            // 4. Notification Syst√®me (Solide)
            if (Notification.permission === "granted") {
                // On essaie via Service Worker pour la fiabilit√©
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'SHOW_NOTIFICATION',
                        title: `üí∞ Commande ${type}`,
                        options: {
                            body: `${amount} TND - Cliquez pour ouvrir`,
                            icon: CUSTOM_ICON,
                            requireInteraction: true, // RESTE AFFICH√â
                            tag: 'alarm'
                        }
                    });
                } else {
                    new Notification(`üí∞ Commande ${type}`, {
                        body: `${amount} TND - Cliquez pour ouvrir`,
                        icon: CUSTOM_ICON,
                        requireInteraction: true // RESTE AFFICH√â
                    });
                }
            }
        }

        function stopAlarm() {
            const sound = document.getElementById('notifSound');
            sound.pause();
            sound.currentTime = 0;
            document.getElementById('customToast').style.top = "-150px"; // Cache la banni√®re
            isAlarmPlaying = false;
            // Si on est sur une autre page, on peut rediriger vers G√©rer
            // document.getElementById('contentFrame').src = 'https://www.speeddelivro.com/admin/orders/listing';
        }

        function checkNewOrders() {
            fetch('https://www.speeddelivro.com/api-check-new-orders.php?nocache=' + Date.now())
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.latest_order) {
                        const newOrder = data.latest_order;
                        if (!lastKnownOrderId) { lastKnownOrderId = newOrder.order_id; localStorage.setItem('last_known_order', lastKnownOrderId); return; }
                        
                        if (newOrder.order_id !== lastKnownOrderId) {
                            const type = newOrder.order_is_admin_created == 1 ? "ADMIN" : "CLIENT";
                            const msg = `Commande : <b>${newOrder.order_id}</b><br>Montant : <b>${newOrder.order_total_amount} TND</b><br>Source : ${type}`;
                            
                            triggerAlarm(msg, type, newOrder.order_total_amount);

                            lastKnownOrderId = newOrder.order_id;
                            localStorage.setItem('last_known_order', lastKnownOrderId);
                        }
                    }
                })
                .catch(e => console.log("Radar..."));
        }

        setInterval(checkNewOrders, 5000);

        // Service Worker (Pour les notifs background)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
        
        // Auto-Restart Audio si interruption
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden && isBackgroundMode) {
               document.getElementById('keepAliveSound').play().catch(e=>{});
            }
        });
    </script>
</body>
</html>
