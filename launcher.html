<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Admin</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://app.speeddelivro.com/admin_icon.png">
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; width: 100vw; overflow: hidden; background: #333; }
        #contentFrame { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 60px); border: none; background: #f5f5f5; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-around; align-items: center; z-index: 9999; }
        .nav-item { text-decoration: none; color: #999; text-align: center; font-size: 11px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; cursor: pointer; }
        .nav-item.active { color: #2563eb; font-weight: bold; background-color: #f0f7ff; }
        .nav-icon { font-size: 22px; margin-bottom: 2px; display: block; }
        #bgModeBtn { position: fixed; top: 10px; right: 10px; padding: 8px 15px; border-radius: 20px; font-size: 12px; z-index: 10000; cursor: pointer; border: 2px solid white; font-weight: bold; }
        .bg-inactive { background: #e74c3c; color: white; }
        .bg-active { background: #2ecc71; color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 50% { box-shadow: 0 0 0 15px rgba(46, 204, 113, 0); } }
        #statusBar { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 5px 10px; border-radius: 10px; font-size: 10px; z-index: 10000; font-family: monospace; }
    </style>
</head>
<body>
    <script>if (localStorage.getItem('admin_auth') !== 'true') window.location.replace('auth.html');</script>

    <iframe id="contentFrame" src="admin-order.html"></iframe>
    <div id="statusBar">‚è∏Ô∏è Radar OFF</div>
    <div id="bgModeBtn" class="bg-inactive" onclick="toggleRadar()">üîï Radar OFF</div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="loadPage('admin-order.html', this)"><span class="nav-icon">‚ûï</span>Cr√©er</div>
        <div class="nav-item" onclick="loadPage('https://www.speeddelivro.com/admin/orders/listing', this)"><span class="nav-icon">üìã</span>G√©rer</div>
        <div class="nav-item" onclick="loadPage('https://www.speeddelivro.com/admin/reports/drivers-map', this)"><span class="nav-icon">üó∫Ô∏è</span>Carte</div>
    </div>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="toast" style="position:fixed;top:-150px;left:5%;width:90%;background:#fff;border-left:5px solid #e74c3c;box-shadow:0 10px 30px rgba(0,0,0,0.3);border-radius:10px;padding:15px;z-index:10001;transition:top 0.4s ease;">
        <div style="display:flex;align-items:center;gap:15px;">
            <div style="font-size:40px;">üîî</div>
            <div><h4 style="margin:0;color:#e74c3c;">Nouvelle Commande!</h4><p id="toastMsg" style="margin:5px 0 0;color:#333;font-size:14px;"></p></div>
        </div>
        <button onclick="hideToast()" style="margin-top:12px;width:100%;padding:12px;background:#2563eb;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;">‚úì OK</button>
    </div>

    <script>
        const API = 'https://www.speeddelivro.com/api-check-new-orders.php';
        let radarOn = false, audioCtx = null, checkTimer = null;
        let alertedIds = JSON.parse(localStorage.getItem('alertedIds') || '[]');

        function loadPage(url, el) {
            document.getElementById('contentFrame').src = url;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        function startAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.value = 0.001;
                osc.frequency.value = 1;
                osc.start();
                return true;
            } catch(e) { return false; }
        }

        function stopAudio() {
            if (audioCtx) { audioCtx.close(); audioCtx = null; }
        }

        function toggleRadar() {
            const btn = document.getElementById('bgModeBtn');
            const bar = document.getElementById('statusBar');
            
            if (!radarOn) {
                if (!startAudio()) { alert('Erreur audio'); return; }
                radarOn = true;
                btn.className = 'bg-active';
                btn.innerHTML = 'üîî Radar ON';
                checkOrders();
                checkTimer = setInterval(checkOrders, 5000);
                if (Notification.permission === 'default') Notification.requestPermission();
            } else {
                radarOn = false;
                stopAudio();
                clearInterval(checkTimer);
                btn.className = 'bg-inactive';
                btn.innerHTML = 'üîï Radar OFF';
                bar.textContent = '‚è∏Ô∏è Radar OFF';
            }
        }

        function showToast(order) {
            const type = order.order_is_admin_created == 1 ? 'ADMIN' : 'CLIENT';
            document.getElementById('toastMsg').innerHTML = `<b>#${order.order_id}</b><br>üí∞ ${order.order_total_amount} TND (${type})`;
            document.getElementById('toast').style.top = '20px';
            document.getElementById('notifSound').play().catch(()=>{});
            if (navigator.vibrate) navigator.vibrate([500,200,500,200,500]);
            if (Notification.permission === 'granted') {
                new Notification('üîî Nouvelle Commande ' + type, { body: order.order_total_amount + ' TND - #' + order.order_id, icon: 'https://app.speeddelivro.com/admin_icon.png', tag: order.order_id });
            }
        }

        function hideToast() { document.getElementById('toast').style.top = '-150px'; }

        function checkOrders() {
            if (!radarOn) return;
            const bar = document.getElementById('statusBar');
            
            fetch(API + '?t=' + Date.now())
                .then(r => r.json())
                .then(data => {
                    if (!data.success) { bar.textContent = '‚ö†Ô∏è Erreur API'; return; }
                    
                    const pending = data.pending_orders || [];
                    const latest = data.latest_order;
                    
                    // M√©thode 1: V√©rifier les commandes pending (status=0)
                    if (pending.length > 0) {
                        bar.textContent = 'üî¥ ' + pending.length + ' commande(s) en attente!';
                        bar.style.background = '#e74c3c';
                        
                        pending.forEach(order => {
                            if (!alertedIds.includes(order.order_id) && order.age_seconds < 600) {
                                showToast(order);
                                alertedIds.push(order.order_id);
                                localStorage.setItem('alertedIds', JSON.stringify(alertedIds.slice(-100)));
                            }
                        });
                    } else {
                        bar.style.background = 'rgba(0,0,0,0.8)';
                        
                        // M√©thode 2 (backup): V√©rifier si nouvelle commande r√©cente
                        if (latest && latest.age_seconds < 300 && !alertedIds.includes(latest.order_id)) {
                            showToast(latest);
                            alertedIds.push(latest.order_id);
                            localStorage.setItem('alertedIds', JSON.stringify(alertedIds.slice(-100)));
                            bar.textContent = '‚úÖ Commande d√©tect√©e | ' + data.server_time;
                        } else {
                            bar.textContent = '‚úÖ RAS | ' + data.server_time;
                        }
                    }
                })
                .catch(() => { bar.textContent = '‚ùå Connexion perdue'; });
        }

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && radarOn) {
                if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
                checkOrders();
            }
        });

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
    </script>
</body>
</html>
